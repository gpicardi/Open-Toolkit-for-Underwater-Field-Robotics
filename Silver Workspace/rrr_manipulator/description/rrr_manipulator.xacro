<?xml version="1.0"?>
<robot xmlns:xacro="http://www.ros.org/wiki/xacro"  name="robot">

    <!--xacro:arg name="use_ros2_control" default="true"/-->
    <xacro:arg name="sim_mode" default="false"/>
     <!-- Import Leg geometry Macro -->
    <xacro:include filename="robot_leg.xacro"/>
     <!-- Import Leg control Macro -->
    <xacro:include filename="ros2_control_leg.xacro"/>
     <!-- Import ROS control -->
    <xacro:include filename="ros2_control_silver.xacro"/>
     <!-- Import Inertia Macros -->
    <xacro:include filename="inertial_macros.xacro"/>
    <!-- Import Constants -->
    <xacro:include filename="rrr_manipulator_constants.xacro"/>
    
    <!-- WORLD LINK -->
    <link name = "world"></link>

    <!-- BODY JOINT AND LINK -->
    <joint name="body_joint" type="fixed">
        <origin xyz="0.0 0.0 ${body_link_height}" rpy="0.0 0.0 0.0"/>
        <parent link="world"/>
        <child link="body_link"/>
    </joint>

    <link name="body_link">
        <visual>
            <origin xyz="0.0 0.0 0.0" rpy="0.0 0.0 0.0"/>
            <geometry>
                <box size="${body_link_x_dim} ${body_link_y_dim} ${body_link_z_dim}"/>
            </geometry>
            <material name="blue"/>
        </visual>
        <collision>
            <origin xyz="0.0 0.0 0.0" rpy="0.0 0.0 0.0"/>
            <geometry>
                <box size="${body_link_x_dim} ${body_link_y_dim} ${body_link_z_dim}"/>
            </geometry>
        </collision>
        <xacro:inertial_box mass="${body_link_mass}" x="${body_link_x_dim}" y ="${body_link_y_dim}" z="${body_link_z_dim}">
            <origin xyz="0.0 0 0.0"/>
        </xacro:inertial_box>
    </link>

    <!-- COXA JOINT AND LINK-->
    <joint name="coxa_joint" type="revolute">
                <origin xyz="${Ox} ${Oy} ${Oz}" rpy="0.0 0.0 0.0"/>
                <parent link="body_link"/>
                <child link="coxa_link"/>
                <limit effort="100" velocity="100.0" lower="-3.14" upper="3.14" />
                <axis xyz="0 0 1"/>
                <dynamics damping="0.7"/>
        </joint>

        <link name="coxa_link">
            <visual>
                <origin xyz="${coxa_link_Ox} ${reflect*coxa_link_Oy} ${coxa_link_Oz}" rpy="0.0 ${coxa_link_Ry} 0.0"/>
                <geometry>
                    <cylinder length="${coxa_link_length}" radius="${coxa_link_radius}"/>
                </geometry>
                <material name="red"/>
            </visual>
            <collision>
                <origin xyz="${coxa_link_Ox} ${coxa_link_Oy} ${coxa_link_Oz}" rpy="0.0 ${coxa_link_Ry} 0.0"/>
                <geometry>
                    <cylinder length="${coxa_link_length}" radius="${coxa_link_radius}"/>
                </geometry>
            </collision>
            <xacro:inertial_cylinder mass="${coxa_link_mass}" length="${coxa_link_length}" radius="${coxa_link_radius}">
                <origin xyz="${coxa_link_Ox} ${coxa_link_Oy} ${coxa_link_Oz}" rpy="0.0 ${coxa_link_Ry} 0.0"/>
            </xacro:inertial_cylinder>
        </link>

        <!-- FEMUR JOINT AND LINK-->
        <joint name="femur_joint" type="revolute">
            <origin xyz="${femur_joint_Ox} ${reflect*femur_joint_Oy} ${femur_joint_Oz}" rpy="0.0 ${femur_joint_Ry} 0.0"/>
            <parent link="coxa_link"/>
            <child link="femur_link"/>
            <limit effort="100" velocity="100.0" lower="-3.14" upper="3.14" />
            <axis xyz="0 0 ${reflect}"/>
            <dynamics damping="0.7"/>
        </joint>

        <link name="femur_link">
            <visual>
                <origin xyz="${femur_link_Ox} 0.0 0.0" rpy="0.0 0.0 0.0"/>
                <geometry>
                    <box size="${femur_link_dx} ${femur_link_dy} ${femur_link_dz}"/>
                </geometry>
                <material name="orange"/>
            </visual>
            <collision>
                <origin xyz="${femur_link_Ox} 0.0 0.0" rpy="0.0 0.0 0.0"/>
                <geometry>
                    <box size="${femur_link_dx} ${femur_link_dy} ${femur_link_dz}"/>
                </geometry>
            </collision>
            <xacro:inertial_box mass="${femur_link_mass}" x="${femur_link_dx}" y="${femur_link_dy}" z='${femur_link_dz}'>
                <origin xyz="${femur_link_Ox} 0.0 0.0" rpy="0.0 0.0 0.0"/>
            </xacro:inertial_box>
        </link>

        <!-- TIBIA JOINT AND LINK -->
        <joint name="tibia_joint" type="revolute">
            <origin xyz="${tibia_joint_Ox} ${tibia_joint_Oy} ${tibia_joint_Oz}" rpy="0.0 0.0 0.0"/>
            <parent link="femur_link"/>
            <child link="tibia_link"/>
            <limit effort="100" velocity="100.0" lower="-3.14" upper="3.14" />
            <axis xyz="0 0 ${reflect}"/>
            <dynamics damping="0.7"/>
        </joint>

        <link name="tibia_link">
            <visual>
                <origin xyz="${tibia_link_Ox} 0.0 0.0" rpy="0.0 0.0 0.0"/>
                <geometry>
                    <box size="${tibia_link_dx} ${tibia_link_dy} ${tibia_link_dz}"/>
                </geometry>
                <material name="black"/>
            </visual>
            <collision>
                <origin xyz="${tibia_link_Ox} 0.0 0.0" rpy="0.0 0.0 0.0"/>
                <geometry>
                    <box size="${tibia_link_dx} ${tibia_link_dy} ${tibia_link_dz}"/>
                </geometry>
            </collision>
            <xacro:inertial_box mass="${tibia_link_mass}" x="${tibia_link_dx}" y="${tibia_link_dy}" z="${tibia_link_dz}">
                <origin xyz="${tibia_link_Ox} 0.0 0.0" rpy="0.0 0.0 0.0"/>
            </xacro:inertial_box>
        </link>

        <!-- ROS2-CONTROL SETTINGS -->
        <ros2_control name="SilverSystem" type="system">
            <xacro:if value="$(arg sim_mode)">
                <hardware>
                    <plugin>gazebo_ros2_control/GazeboSystem</plugin>
                </hardware>
            </xacro:if>
            <xacro:unless value="$(arg sim_mode)">
                <hardware>
                    <plugin>dynamixel_hardware/DynamixelHardware</plugin>
                    <param name="usb_port">/dev/ttyUSB0</param>
                    <param name="baud_rate">1000000</param>
                </hardware>
            </xacro:unless>
        </ros2_control> 

        <!-- COXA JOINT ROS2-CONTROL PAREMETERS -->
        <joint name="coxa_joint">
        <param name="id">0</param>

            <command_interface name="position">
                <param name="min">-3.14</param>
                <param name="max">3.14</param>
            </command_interface>
            
            <command_interface name="velocity"/>

            <xacro:if value="$(arg sim_mode)">
                <command_interface name="effort"/>
            </xacro:if>  

            <state_interface name="position"/>
            <state_interface name="velocity"/>
            <state_interface name="effort"/>
        </joint>

        <!-- FEMUR JOINT ROS2-CONTROL PAREMETERS -->
        <joint name="femur_joint">
        <param name="id">1</param>

            <command_interface name="position">
                <param name="min">-3.14</param>
                <param name="max">3.14</param>
            </command_interface>

            <command_interface name="velocity"/>

            <xacro:if value="$(arg sim_mode)">
                <command_interface name="effort"/>
            </xacro:if>  

            <state_interface name="position"/>
            <state_interface name="velocity"/>
            <state_interface name="effort"/>
        </joint>

        <!-- TIBIA JOINT ROS2-CONTROL PAREMETERS -->
        <joint name="tibia_joint">
        <param name="id">2</param>

            <command_interface name="position">
                <param name="min">-3.14</param>
                <param name="max">3.14</param>
            </command_interface>

            <command_interface name="velocity"/>

            <xacro:if value="$(arg sim_mode)">
                <command_interface name="effort"/>
            </xacro:if>  
            
            <state_interface name="position"/>
            <state_interface name="velocity"/>
            <state_interface name="effort"/>
        </joint>

        <!-- COXA JOINT ROS2-CONTROL TRANSMISSION -->
        <transmission name="coxa_transmission">
            <plugin>transmission_interface/SimpleTransmission</plugin>
            <actuator name="coxa_actuator" role="coxa_actuator"/>
            <joint name="coxa_joint" role="coxa_joint">
                <mechanical_reduction>${coxa_reduction}</mechanical_reduction>
                <offset>${coxa_offset}</offset>
            </joint>
        </transmission>

         <!-- FEMUR JOINT ROS2-CONTROL TRANSMISSION -->
        <transmission name="femur_transmission">
            <plugin>transmission_interface/SimpleTransmission</plugin>
            <actuator name="femur_actuator" role="femur_actuator"/>
            <joint name="femur_joint" role="fermur_joint">
                <mechanical_reduction>${femur_reduction}</mechanical_reduction>
                <offset>${femur_offset}</offset>
            </joint>
        </transmission>

         <!-- TIBIA JOINT ROS2-CONTROL TRANSMISSION -->
        <transmission name="tibia_transmission">
            <plugin>transmission_interface/SimpleTransmission</plugin>
            <actuator name="tibia_actuator" role="tibia_actuator"/>
            <joint name="tibia_joint" role="tibia_joint">
                <mechanical_reduction>${tibia_reduction}</mechanical_reduction>
                <offset>${tibia_offset}</offset>
            </joint>
      </transmission>
</robot>
